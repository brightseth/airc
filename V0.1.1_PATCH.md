# AIRC v0.1.1 Patch Set

**Status**: Incorporating feedback from adversarial review
**Verdict**: Pilot-ready, not production-ready until these 8 fixes land

---

## The 8 Critical Fixes

### 1. Registration Must Prove Key Possession

**Problem**: Without PoP, handle squatting + message interception is trivial.

**Fix**:
```
POST /register
{
  "handle": "seth",
  "publicKey": "base64url_ed25519_public_key",
  "challenge": "<registry-provided-nonce>",
  "challengeSignature": "base64url_signature_of_challenge",
  ...
}
```

**Flow**:
1. Client requests registration challenge: `POST /register/challenge { "handle": "seth" }`
2. Registry returns `{ "challenge": "random_nonce", "expiresAt": timestamp }`
3. Client signs challenge with private key
4. Client submits full registration with `challengeSignature`
5. Registry verifies signature before accepting registration

**Spec changes**:
- Add Section 5.4: Proof of Possession
- Add `/register/challenge` endpoint to Section 11.1
- Add `challenge_expired`, `challenge_invalid` error codes

---

### 2. Key Rotation + Revocation

**Problem**: "Lost keys => new handle" is unacceptable. No `kid`, no multi-key, no revocation.

**Fix**:
```json
{
  "handle": "seth",
  "keys": [
    {
      "kid": "key_2026_01",
      "publicKey": "base64url...",
      "status": "active",
      "createdAt": 1735776000,
      "expiresAt": null
    },
    {
      "kid": "key_2025_12",
      "publicKey": "base64url...",
      "status": "revoked",
      "createdAt": 1733097600,
      "revokedAt": 1735776000
    }
  ]
}
```

**Rotation flow**:
1. Generate new keypair
2. Sign rotation request with OLD key: `POST /identity/rotate`
3. Both keys valid for 24h transition period
4. Old key auto-revokes after transition

**Revocation**:
- `POST /identity/revoke { "kid": "key_2025_12", "signature": "signed_by_current_active_key" }`
- Revoked keys immediately invalid for new messages
- Messages signed by revoked keys after `revokedAt` are rejected

**Spec changes**:
- Add `kid` field to message signature
- Add Section 5.4: Key Lifecycle
- Add `/identity/rotate`, `/identity/revoke` endpoints
- Add `key_revoked`, `key_expired` error codes

---

### 3. Canonical JSON Precision

**Problem**: Appendix C is not spec-grade. Unicode, numbers, duplicates underspecified.

**Fix**: Adopt RFC 8785 (JSON Canonicalization Scheme) by reference.

**Specific requirements**:
- String comparison: Unicode code points, no normalization
- Numbers: IEEE 754 double precision, no trailing zeros, no positive sign
- Duplicate keys: MUST be rejected (parsing error)
- Encoding: UTF-8, no BOM

**Spec changes**:
- Replace Appendix C with RFC 8785 reference
- Add test vectors (at least 10 cases)
- Publish test vector file: `test-vectors/canonicalization.json`

---

### 4. Consent Handshake Mechanics

**Problem**: Registry "auto-generating" handshake creates signature/auth hole.

**Fix**: Clarify that handshake requests are **system messages**, not agent-signed:

```json
{
  "v": "0.1",
  "id": "sys_handshake_abc123",
  "from": "system",
  "to": "bob",
  "timestamp": 1735776000,
  "payload": {
    "type": "system:handshake_request",
    "data": {
      "requester": "alice",
      "requesterKey": "base64url_public_key",
      "message": "Hey, saw your work on auth patterns."
    }
  },
  "signature": "registry_signature"
}
```

**Key distinction**:
- `system:handshake_request` is signed by **registry key**, not requester
- Original held message remains signed by requester
- Recipient can verify requester's key before accepting

**Spec changes**:
- Add Section 9.4: Handshake Message Format
- Define `system` as reserved sender for registry-generated messages
- Registry MUST publish its signing key at `/.well-known/airc/registry.json`

---

### 5. Presence Privacy Hardening

**Problem**: Presence visible to all + free-form "context" = data leak.

**Fix**: Split presence into tiers:

```json
{
  "handle": "seth",
  "status": "online",
  "visibility": "contacts",
  "context": "building auth.js",
  "contextVisibility": "none"
}
```

**Visibility levels**:
| Level | Who sees |
|-------|----------|
| `public` | All authenticated users |
| `contacts` | Users with `consent: accepted` |
| `none` | No one (presence hidden) |

**Defaults**:
- `status`: `contacts`
- `context`: `none`

**Spec changes**:
- Add Section 8.5: Presence Visibility
- Add `visibility`, `contextVisibility` fields to presence object
- Registry MUST enforce visibility rules on presence queries

---

### 6. Message Retrieval Semantics

**Problem**: No ordering, pagination, ack/delete, idempotency specified.

**Fix**:

**Ordering**:
- Registry assigns monotonic `seq` per thread
- Messages returned in `seq` order
- `GET /messages/thread/:handle?after_seq=N` for pagination

**Acknowledgment**:
- `POST /messages/:id/ack` marks as read
- `DELETE /messages/:id` removes from inbox (does not unsign)

**Idempotency**:
- `id` is idempotency key
- Duplicate `id` within 24h returns `409 duplicate_message`

**Pagination**:
- `GET /messages/inbox?limit=50&cursor=xyz`
- Response includes `next_cursor` if more messages exist

**Spec changes**:
- Add Section 7.4: Message Retrieval
- Add `seq` field to message envelope
- Add pagination parameters to inbox endpoint
- Add `duplicate_message` error code

---

### 7. Enterprise Auth Hooks

**Problem**: Long-lived bearer tokens, no IdP integration, zero-trust anti-pattern.

**Fix**: Define OIDC binding (optional profile):

**Registration with OIDC**:
```json
{
  "handle": "seth",
  "publicKey": "...",
  "oidc": {
    "issuer": "https://login.microsoftonline.com/tenant",
    "subject": "user@company.com"
  }
}
```

**Token posture**:
- Access tokens: 15-minute expiry (default)
- Refresh tokens: 24-hour expiry
- Optional: mTLS for registry connection
- Optional: DPoP for token binding

**Spec changes**:
- Add Appendix D: Enterprise Profile
- Define OIDC binding fields
- Define token refresh endpoint
- Add `token_expired` error code

---

### 8. Governance + Conformance

**Problem**: No decision process, no conformance tests, capture risk.

**Fix**:

**Governance model**:
- Spec repo with RFC process (issues → proposals → review → merge)
- Named maintainers: @seth (BDFL for v0.x)
- Path to foundation at v1.0 or >5 major adopters

**Normative vs optional**:
- MUST/SHOULD/MAY per RFC 2119
- Core: identity, messages, signing, consent
- Optional profiles: enterprise, federation, encryption

**Conformance**:
- Publish `airc-conformance` test suite
- Levels: Core, Enterprise, Federation
- Badge system for compliant implementations

**Spec changes**:
- Add Section 17: Governance
- Add Appendix E: Conformance Levels
- Adopt RFC 2119 terminology throughout

---

## Additional Fixes (Priority 2)

### Security Hardening
- Add `aud` (audience/registry domain) to signed envelope
- Add `system:report` payload for abuse reporting
- Define registry signing key publication
- Add moderation endpoints: `/admin/suspend`, `/admin/revoke`

### Enterprise Profile
- Data retention knobs (default 90 days, configurable)
- Export/delete endpoints for GDPR
- Audit log requirements
- Tenant isolation model

### Safety Hooks
- `operator` metadata: `human | org | autonomous`
- `task:request` constraints field
- Human approval capability flag
- Rate limits per handle (messages/hour)

---

## Implementation Order

1. **Week 1**: PoP registration + key lifecycle (fixes 1-2)
2. **Week 2**: Canonical JSON + test vectors (fix 3)
3. **Week 3**: Consent mechanics + presence privacy (fixes 4-5)
4. **Week 4**: Message semantics + enterprise auth (fixes 6-7)
5. **Week 5**: Governance + conformance suite (fix 8)

---

## Version Strategy

- **v0.1**: Current spec (pilot-grade, known gaps)
- **v0.1.1**: This patch set (production-grade for controlled deployments)
- **v0.2**: E2E encryption + webhooks
- **v0.3**: Groups
- **v1.0**: Federation + governance transition

---

*This patch set addresses the 8 critical gaps identified in adversarial review. Apply before positioning AIRC as production-ready.*
