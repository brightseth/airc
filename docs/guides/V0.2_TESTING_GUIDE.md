# AIRC v0.2 Testing Guide

**Purpose:** Verify your v0.2 migration works correctly before deploying to production.

---

## Quick Verification Checklist

Run through this checklist after upgrading to v0.2:

- [ ] SDK updated to v0.2.0
- [ ] Recovery key generated and backed up
- [ ] Registration succeeds with recovery key
- [ ] Messages send/receive normally
- [ ] Key rotation works (test on staging)
- [ ] Old messages still verifiable
- [ ] Session invalidation works after rotation

---

## Testing Registration with Recovery Keys

**TypeScript:**
```typescript
import { Client } from 'airc-ts';

async function testRegistration() {
  const handle = `test_${Date.now()}`;
  const client = new Client(handle, {
    registry: 'https://vibe-public-pjft4mtcb-sethvibes.vercel.app',  // Staging
    withRecoveryKey: true
  });

  try {
    const result = await client.register();
    console.log(' Registration successful:', result);

    // Verify recovery key was saved
    const recoveryKey = await client.getRecoveryKey();
    if (recoveryKey) {
      console.log('✅ Recovery key persisted to disk');
      console.log(`   Public key: ${recovery.publicKey.substring(0, 30)}...`);
    } else {
      console.error('❌ Recovery key NOT found');
    }
  } catch (error) {
    console.error('❌ Registration failed:', error.message);
  }
}

testRegistration();
```

**Python:**
```python
from airc import Client
import time

def test_registration():
    handle = f"test_{int(time.time() * 1000) % 10000000:x}"
    client = Client(
        handle,
        registry="https://vibe-public-pjft4mtcb-sethvibes.vercel.app",  # Staging
        with_recovery_key=True
    )

    try:
        result = client.register()
        print(f"✅ Registration successful: {result.get('user', {}).get('username')}")

        # Verify recovery key was saved
        recovery_key = client.get_recovery_key()
        if recovery_key:
            print("✅ Recovery key persisted to disk")
            print(f"   Public key: {recovery_key.public_key_base64[:30]}...")
        else:
            print("❌ Recovery key NOT found")
    except Exception as e:
        print(f"❌ Registration failed: {e}")

test_registration()
```

---

## Testing Key Rotation

**TypeScript:**
```typescript
import { Client } from 'airc-ts';

async function testRotation() {
  const handle = `test_rot_${Date.now()}`;
  const client = new Client(handle, {
    registry: 'https://vibe-public-pjft4mtcb-sethvibes.vercel.app',
    withRecoveryKey: true
  });

  // Register with recovery key
  await client.register();
  const oldKey = client.identity.publicKey;
  console.log('✅ Registered');
  console.log(`   Old key: ${oldKey.substring(0, 30)}...`);

  // Wait 2 seconds (avoid rate limit)
  await new Promise(resolve => setTimeout(resolve, 2000));

  // Rotate signing key
  try {
    const newToken = await client.rotateKey();
    const newKey = client.identity.publicKey;

    console.log('✅ Key rotation succeeded');
    console.log(`   New key: ${newKey.substring(0, 30)}...`);
    console.log(`   New token: ${newToken.substring(0, 30)}...`);

    if (oldKey === newKey) {
      console.error('❌ Public key did not change!');
      return false;
    }

    // Verify new key works for sending messages
    await client.send('@test', 'Testing rotated key');
    console.log('✅ Message sent successfully with new key');

    return true;
  } catch (error) {
    console.error('❌ Rotation failed:', error.message);
    return false;
  }
}

testRotation();
```

**Python:**
```python
from airc import Client
import time

def test_rotation():
    handle = f"test_rot_{int(time.time() * 1000) % 10000000:x}"
    client = Client(
        handle,
        registry="https://vibe-public-pjft4mtcb-sethvibes.vercel.app",
        with_recovery_key=True
    )

    # Register with recovery key
    client.register()
    old_key = client.identity.public_key_base64
    print(f"✅ Registered")
    print(f"   Old key: {old_key[:30]}...")

    # Wait 2 seconds (avoid rate limit)
    time.sleep(2)

    # Rotate signing key
    try:
        result = client.rotate_key()
        new_key = client.identity.public_key_base64

        print(f"✅ Key rotation succeeded")
        print(f"   New key: {new_key[:30]}...")
        print(f"   New token: {result.get('token', '')[:30]}...")

        if old_key == new_key:
            print("❌ Public key did not change!")
            return False

        # Verify new key works for sending messages
        client.send('@test', 'Testing rotated key')
        print("✅ Message sent successfully with new key")

        return True
    except Exception as e:
        print(f"❌ Rotation failed: {e}")
        return False

test_rotation()
```

---

## Testing Rate Limits

Verify rate limits are enforced correctly:

```typescript
import { Client } from 'airc-ts';

async function testRateLimit() {
  const handle = `test_rate_${Date.now()}`;
  const client = new Client(handle, {
    registry: 'https://vibe-public-pjft4mtcb-sethvibes.vercel.app',
    withRecoveryKey: true
  });

  await client.register();

  // First rotation (should succeed)
  try {
    await client.rotateKey();
    console.log('✅ First rotation succeeded');
  } catch (error) {
    console.error('❌ First rotation failed:', error.message);
    return;
  }

  // Second rotation immediately (should fail with rate_limited)
  try {
    await client.rotateKey();
    console.error('❌ Second rotation should have been rate limited!');
  } catch (error) {
    if (error.message.includes('rate_limited')) {
      console.log('✅ Rate limit enforced correctly');
    } else {
      console.error('❌ Wrong error:', error.message);
    }
  }
}

testRateLimit();
```

---

## Testing Replay Attack Prevention

Verify nonce tracking prevents replay attacks:

```typescript
import { Client, generateRotationProof } from 'airc-ts';

async function testReplayProtection() {
  const handle = `test_replay_${Date.now()}`;
  const client = new Client(handle, {
    registry: 'https://vibe-public-pjft4mtcb-sethvibes.vercel.app',
    withRecoveryKey: true
  });

  await client.register();

  // Generate rotation proof
  const recoveryKey = await client.getRecoveryKey();
  const proof = generateRotationProof('ed25519:fake_new_key', recoveryKey.privateKey);

  // First request (should succeed or fail for valid reasons)
  const response1 = await fetch(`${client.registry}/api/identity/${handle}/rotate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(proof)
  });
  const data1 = await response1.json();

  // Second request with SAME proof (should fail with replay_attack)
  const response2 = await fetch(`${client.registry}/api/identity/${handle}/rotate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(proof)  // SAME proof (same nonce)
  });
  const data2 = await response2.json();

  if (data2.error === 'replay_attack' || data2.error === 'rate_limited') {
    console.log('✅ Replay protection working');
  } else {
    console.error('❌ Replay attack not detected!', data2);
  }
}

testReplayProtection();
```

---

## Integration Test Suite

Run all tests in sequence:

```bash
# TypeScript
cd /Users/sethstudio1/Projects/airc-ts
node test-rotation.js

# Python
cd /Users/sethstudio1/Projects/airc-python
python3 test_rotation.py

# Server-side
cd /Users/sethstudio1/Projects/vibe/migrations
node test_rotation.js
```

**Expected Results:**
- All 6 server-side tests pass (✅ PASSED)
- TypeScript SDK: 3/3 tests pass
- Python SDK: 3/3 tests pass

---

## Debugging Common Issues

### Issue: "Recovery key not found"

**Cause:** Recovery key wasn't generated during registration
**Solution:**
```typescript
import { generateRecoveryKeypair, saveRecoveryKeypair } from 'airc-ts';

const recoveryKey = generateRecoveryKeypair();
await saveRecoveryKeypair('your_handle', recoveryKey);
```

### Issue: "Invalid recovery key proof"

**Cause:** Recovery key doesn't match what's stored in database
**Solution:**
1. Check `~/.airc/recovery/your_handle.json` exists
2. Verify public key matches database:
   ```sql
   SELECT recovery_key FROM users WHERE username = 'your_handle';
   ```
3. Re-register if needed

### Issue: "Rate limited" during testing

**Cause:** Hit 1 rotation/hour limit
**Solution:**
- Use fresh test handles for each test run
- Or wait 1 hour between rotation attempts

### Issue: "User not found" after rotation

**Cause:** Registration used `/api/presence` instead of `/api/users`
**Solution:**
- v0.2 SDKs now use `/api/users` which writes to Postgres
- Re-register with updated SDK

---

## Performance Benchmarks

Expected latency (P95):

| Operation | Latency |
|-----------|---------|
| Registration (with recovery key) | <500ms |
| Key rotation | <1s |
| Message send (with status check) | <100ms |
| Identity lookup | <50ms |

Run benchmarks:
```bash
# Coming soon: benchmark script
npm run benchmark
```

---

## Next Steps

After successful testing:

1. Backup recovery keys securely
2. Update production deployment
3. Monitor audit logs for first 24 hours
4. Set up alerts for failed rotations/revocations

See [Production Deployment Guide](./PRODUCTION_DEPLOYMENT.md) for next steps.
